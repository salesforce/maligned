<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>free monad implemented with a type-aligned list · maligned</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content='docs'/>
<link rel="canonical" href="https://github.com/salesforce/malignedfree.html"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:100normal,100italic,300normal,300italic,400normal,400italic,500normal,500italic,700normal,700italic,900normal,900italicc" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="js/page.js"></script>
<script type="text/javascript" src="js/warnOldVersion.js"></script>
<script type="text/javascript" src="js/groups.js"></script>
<link rel="stylesheet" type="text/css" href="lib/foundation/dist/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="css/page.css"/>

<!--
<link rel="shortcut icon" href="images/favicon.ico" />
-->
</head>

<body>
<div class="off-canvas-wrapper">
<div class="off-canvas-wrapper-inner" data-off-canvas-wrapper>

<div class="off-canvas position-left" id="off-canvas-menu" data-off-canvas>
<nav class="off-canvas-nav">
<div class="nav-home">
<a href="index.html" >
<span class="home-icon">⌂</span>maligned
</a>
<div class="version-number">
0.0.0+1-5d285807*
</div>
</div>
<div class="nav-toc">
<ul>
  <li><a href="data-pipeline.html" class="page">type-aligned data pipeline</a></li>
  <li><a href="list-gen.html" class="page">type-aligned list generation</a></li>
  <li><a href="free.html" class="active page">free monad implemented with a type-aligned list</a></li>
</ul>
</div>

</nav>
</div>

<div class="off-canvas-content" data-off-canvas-content>

<header class="site-header expanded row">
<div class="small-12 column">
<a href="#" class="off-canvas-toggle hide-for-medium" data-toggle="off-canvas-menu"><svg class="svg-icon svg-icon-menu" version="1.1" id="Menu" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 20 20" enable-background="new 0 0 20 20" xml:space="preserve"> <path class="svg-icon-menu-path" fill="#53CDEC" d="M16.4,9H3.6C3.048,9,3,9.447,3,10c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,9.447,16.952,9,16.4,9z M16.4,13
H3.6C3.048,13,3,13.447,3,14c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,13.447,16.952,13,16.4,13z M3.6,7H16.4
C16.952,7,17,6.553,17,6c0-0.553-0.048-1-0.6-1H3.6C3.048,5,3,5.447,3,6C3,6.553,3.048,7,3.6,7z"/></svg>
</a>
<div class="title"><a href="index.html">maligned</a></div>

<!--
<a href="https://www.example.com" class="logo show-for-medium">logo</a>
-->
</div>
</header>

<div class="expanded row">

<div class="medium-3 large-2 show-for-medium column">
<nav class="site-nav">
<div class="nav-home">
<a href="index.html" >
<span class="home-icon">⌂</span>maligned
</a>
<div class="version-number">
0.0.0+1-5d285807*
</div>
</div>
<div class="nav-toc">
<ul>
  <li><a href="data-pipeline.html" class="page">type-aligned data pipeline</a></li>
  <li><a href="list-gen.html" class="page">type-aligned list generation</a></li>
  <li><a href="free.html" class="active page">free monad implemented with a type-aligned list</a></li>
</ul>
</div>

</nav>
</div>

<div class="small-12 medium-9 large-10 column">
<section class="site-content">

<span id="version-warning"></span>

<div class="page-header row">
<div class="medium-12 show-for-medium column">
<div class="nav-breadcrumbs">
<ul>
  <li><a href="index.html">maligned</a></li>
  <li>free monad implemented with a type-aligned list</li>
</ul>
</div>
</div>
</div>

<div class="page-content row">
<div class="small-12 large-9 column" id="docs">
<h1><a href="#free-monad-implemented-with-a-type-aligned-list" name="free-monad-implemented-with-a-type-aligned-list" class="anchor"><span class="anchor-link"></span></a>free monad implemented with a type-aligned list</h1>
<p>This document provides an example of how a free monad could be implemented using a type-aligned list. It introduces lower-level techniques that can be used with type-aligned lists, such as destructuring via the <a href="api/com/salesforce/maligned/TANonEmptyList.html#uncons1" title="maligned.TANonEmptyList"><code>uncons1</code></a> method.</p>
<p>This document assumes that the reader is already familiar with the concept of free monads. If you want an introduction to free monads and their common use-cases, there are a number of resources available online such as the <a href="https://typelevel.org/cats/datatypes/freemonad.html">Cats free monad documentation</a>.</p>
<p>There are many ways to implement free monads in Scala, and this particular implementation is mostly meant for demonstrative/learning purposes. Having said that, this is a fairly reasonable way to implement a free monad in Scala. Unlike many naive Scala implementations of free monads, it is stack-safe (that is, it won&rsquo;t throw a stack overflow exception). It&rsquo;s performance should also be reasonable (though this should be verified with benchmarks).</p>
<h2><a href="#the-freemonad-data-structure" name="the-freemonad-data-structure" class="anchor"><span class="anchor-link"></span></a>the FreeMonad data structure</h2>
<p>We start off by defining an abstract FreeMonad type for an effect type <code>F[_]</code> and result value of type <code>A</code>:</p>
<pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/salesforce/maligned/tree/main/core-tests/src/test/scala/example/FreeMonad.scala#L17" target="_blank" title="Go to snippet source"></a><code class="language-scala">sealed abstract class FreeMonad[F[_], A]</code></pre>
<p>This is a bare-bones <code>FreeMonad</code> type and at this point doesn&rsquo;t define anything useful; we&rsquo;ll add that later.</p>
<p>We&rsquo;ll need some ways to construct a <code>FreeMonad</code>. The two most straightforward ways to create a <code>FreeMonad[F[_], A]</code> value are by simply wrapping an <code>A</code> value (the <code>Pure</code> constructor) or an <code>F[A]</code> value (the <code>Suspend</code> constructor). Both <code>Pure</code> and <code>Suspend</code> wrap a value without providing a &ldquo;continuation&rdquo; function to later apply to the value. We&rsquo;ll make them extend a common <code>NoCont</code> (_no continuation_) super-type which will end up being useful later on.</p>
<pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/salesforce/maligned/tree/main/core-tests/src/test/scala/example/FreeMonad.scala#L22-L36" target="_blank" title="Go to snippet source"></a><code class="language-scala">/**
 * A free monad that wraps a value and does not provide any &quot;continuation&quot; functions to apply to
 * the value
 */
sealed abstract class NoCont[F[_], A] extends FreeMonad[F, A]

/** A pure `A` value */
final case class Pure[F[_], A](value: A) extends NoCont[F, A]

/** An `A` value in an `F` effect context */
final case class Suspend[F[_], A](value: F[A]) extends NoCont[F, A]

def pure[F[_], A](value: A): FreeMonad[F, A] = Pure(value)

def suspend[F[_], A](value: F[A]): FreeMonad[F, A] = Suspend(value)</code></pre>
<p>The third and final way to construct a <code>FreeMonad</code> value is to call <code>flatMap</code> on a <code>FreeMonad[F, A]</code> value, providing a function of type <code>A =&gt; FreeMonad[F, B]</code> to produce a <code>FreeMonad[F, B]</code> value. We&rsquo;ll refer to functions of this <code>A =&gt; FreeMonad[F, B]</code> form as <em>continuations</em>, as they describe a way to continue the computation once an <code>A</code> value has been produced. In fact, let&rsquo;s go ahead and define a <code>Cont</code> type alias for continuation functions:</p>
<pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/salesforce/maligned/tree/main/core-tests/src/test/scala/example/FreeMonad.scala#L40-L41" target="_blank" title="Go to snippet source"></a><code class="language-scala">/** A continuation that takes an A value and returns a new FreeMonad to continue the computation */
type Cont[F[_], A, B] = A =&gt; FreeMonad[F, B]</code></pre>
<p>Now we can define a constructor for free monads that are created via <code>flatMap</code>. It will have two fields:</p>
<ul>
  <li>The initial <code>FreeMonad[F, A]</code> value upon which <code>flatMap</code> was called (<code>init</code>)</li>
  <li>A non-empty list of continuation functions (<code>conts</code>). This will have a single value if <code>flatMap</code> was only called once, and will have an additional value for each time that <code>flatMap</code> is called.</li>
</ul>
<pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/salesforce/maligned/tree/main/core-tests/src/test/scala/example/FreeMonad.scala#L45-L48" target="_blank" title="Go to snippet source"></a><code class="language-scala">final private case class FlatMapped[F[_], A, B](
  init: NoCont[F, A],
  conts: TANonEmptyList.Rev[Cont[F, *, *], A, B])
    extends FreeMonad[F, B]</code></pre>
<p>The astute reader may have noticed that we used <code>TANonEmptyList.Rev</code> as opposed to <code>TANonEmptyList</code> for the continuations. This is an optimization and isn&rsquo;t strictly necessary. Prepending to a <code>TANonEmptyList</code> is more efficient than appending to it (constant time as opposed to linear time), so we prepend to the continuation list every time that <code>flatMap</code> is called, resulting in a reversed list of continuations. Operations that consume the free monad value will most likely need to reverse the list, which is a linear-time operation, but better one linear-time operation than many.</p>
<h2><a href="#putting-the-monad-in-free-monad" name="putting-the-monad-in-free-monad" class="anchor"><span class="anchor-link"></span></a>putting the monad in free monad</h2>
<p>Now we have all the pieces in place to be able to define a <code>Monad</code> instance for <code>Free</code>!</p>
<pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/salesforce/maligned/tree/main/core-tests/src/test/scala/example/FreeMonad.scala#L52-L62" target="_blank" title="Go to snippet source"></a><code class="language-scala">implicit def monadForFreeMonad[F[_]]: Monad[FreeMonad[F, *]] =
  new StackSafeMonad[FreeMonad[F, *]] {

    override def pure[A](x: A): FreeMonad[F, A] = Pure(x)

    override def flatMap[A, B](fa: FreeMonad[F, A])(f: A =&gt; FreeMonad[F, B]): FreeMonad[F, B] =
      fa match {
        case x: NoCont[F, A] =&gt; FlatMapped(x, TANonEmptyList.revOne[Cont[F, *, *], A, B](f))
        case FlatMapped(init, conts) =&gt; FlatMapped(init, f :: conts)
      }
  }</code></pre>
<h2><a href="#implementing-foldmap" name="implementing-foldmap" class="anchor"><span class="anchor-link"></span></a>implementing foldMap</h2>
<p>A free monad value is only useful if you can consume it. One of the most common ways to consume a free monad value is with a <code>foldMap</code> method that recursively steps through the free monad value, translating all <code>F[_]</code> values into <code>G[_]</code> values via a provided <code>FunctionK[F, G]</code>. The signature for <code>foldMap</code> looks like this:</p>
<pre class="prettyprint"><code class="language-scala">def foldMap[F[_], G[_], A](fa: FreeMonad[F, A])(f2g: FunctionK[F, G])(implicit G: Monad[G]): G[A]
</code></pre>
<p>Implementing <code>foldMap</code> for <code>NoCont</code> values is pretty straightforward, so let&rsquo;s start with that:</p>
<pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/salesforce/maligned/tree/main/core-tests/src/test/scala/example/FreeMonad.scala#L66-L71" target="_blank" title="Go to snippet source"></a><code class="language-scala">def foldMapNoCont[F[_], G[_], A](fa: NoCont[F, A])(f2g: FunctionK[F, G])(implicit
  G: Monad[G]): G[A] =
  fa match {
    case Pure(value) =&gt; G.pure(value)
    case Suspend(value) =&gt; f2g(value)
  }</code></pre>
<p>Implementing <code>foldMap</code> for the <code>FlatMapped</code> case in a stack-safe manner is significantly more complicated. We&rsquo;ll take the approach of keeping track of the current input value and a stack (a <code>TANonEmptyList</code> structure) of continuations that still need to be run. First let&rsquo;s define some helper type aliases for the (input, continuation) stack pairs:</p>
<pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/salesforce/maligned/tree/main/core-tests/src/test/scala/example/FreeMonad.scala#L75-L95" target="_blank" title="Go to snippet source"></a><code class="language-scala">/**
 * A stack of continuations.
 *
 * @tparam I the input type of the first continuation
 * @tparam O the output type of the last continuation
 */
type Conts[F[_], I, O] = TANonEmptyList[Cont[F, *, *], I, O]

/**
 * A stack of continuations along with the input for the first continuation.
 *
 * This is essentially a tuple `(I, Conts[F, I, O])` of an input `I` value and a list of
 * continuations to pass the input value into. `Tuple2K` is used instead of a vanilla tuple,
 * because the `I` type is an unknown/existential type; `Tuple2K` ensures that it lines up between
 * the input value and the first continuation.
 */
type InputAndConts[F[_], O] = TATuple2K[Id, Conts[F, *, O]]

/** Simple helper method to create `InputAndConts` values */
@inline def makeInputAndConts[F[_], I, A](input: I, conts: Conts[F, I, A]): InputAndConts[F, A] =
  TATuple2K[Id, Conts[F, *, A], I](input, conts)</code></pre>
<p>We&rsquo;ll utilize these helpers in a function that performs a single &ldquo;step&rdquo; of the <code>foldMap</code>:</p>
<ul>
  <li>Pop the next continuation off of the stack.</li>
  <li>Pass the current input value into the popped continuation.</li>
  <li>If any further continuations are returned, prepend them to the stack.</li>
  <li>Find the input value for the next continuation.</li>
  <li>If there are no more continuations, return a <code>Right</code> wrapping the final value. Otherwise return a <code>Left</code> with the remaining continuation stack and the input value for the next continuation.</li>
</ul>
<pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/salesforce/maligned/tree/main/core-tests/src/test/scala/example/FreeMonad.scala#L103-L128" target="_blank" title="Go to snippet source"></a><code class="language-scala">def foldMapStep[F[_], G[_], A](inputAndConts: InputAndConts[F, A])(f2g: FunctionK[F, G])(implicit
  G: Monad[G]): G[Either[InputAndConts[F, A], A]] =
  inputAndConts.second.uncons1 match {
    // last continuation on the stack
    case Left(cont) =&gt;
      // run the continuation on the input value
      cont(inputAndConts.first) match {
        // nothing to add to the stack; we are done
        case y: NoCont[F, A] =&gt; foldMapNoCont(y)(f2g).map(Right(_))
        // new continuations to add to the stack
        case FlatMapped(init, conts) =&gt;
          foldMapNoCont(init)(f2g).map(x =&gt; Left(makeInputAndConts(x, conts.reverse)))
      }
    // multiple continuations on the stack
    case Right(conts) =&gt;
      // run the first continuation on the input value
      conts.head(inputAndConts.first) match {
        // the result doesn&#39;t add any continuations to the stack
        case y: NoCont[F, conts.P] =&gt;
          foldMapNoCont(y)(f2g).map(x =&gt; Left(makeInputAndConts(x, conts.tail)))
        // the result adds continuations on the stack
        case FlatMapped(init, additionalConts) =&gt;
          foldMapNoCont(init)(f2g).map(x =&gt;
            Left(makeInputAndConts(x, conts.tail.prependReversed(additionalConts))))
      }
  }</code></pre>
<p>Finally we can define <code>foldMap</code>:</p>
<pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/salesforce/maligned/tree/main/core-tests/src/test/scala/example/FreeMonad.scala#L132-L142" target="_blank" title="Go to snippet source"></a><code class="language-scala">def foldMap[F[_], G[_], A](fa: FreeMonad[F, A])(f2g: FunctionK[F, G])(implicit
  G: Monad[G]): G[A] =
  fa match {
    // simple case of no continations; we are done!
    case x: NoCont[F, A] =&gt; foldMapNoCont(x)(f2g)
    // continuations exist; we&#39;ll need to step through the stack of continuations one at a time
    case FlatMapped(init, conts) =&gt;
      // calculate the initial value and then recursively `step` through the continuation stack
      foldMapNoCont(init)(f2g).flatMap(v =&gt;
        G.tailRecM(makeInputAndConts(v, conts.reverse))(foldMapStep(_)(f2g)))
  }</code></pre>
<h2><a href="#using-foldmap" name="using-foldmap" class="anchor"><span class="anchor-link"></span></a>using foldMap</h2>
<p>To convince ourselves that our <code>foldMap</code> implementation is correct and stack-safe, we can use a classic example of using <code>Function0</code> as the <code>F[_]</code> type to create a <a href="https://medium.com/@olxc/trampolining-and-stack-safety-in-scala-d8e86474ddfa">trampoline</a> and compute a value via two mutually-recursive functions that would not be stack-safe in the absence of trampolining.</p>
<pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/salesforce/maligned/tree/main/core-tests/src/test/scala/example/FreeMonad.scala#L148-L166" target="_blank" title="Go to snippet source"></a><code class="language-scala">type Trampoline[A] = FreeMonad[Function0, A]

def defer[A](delayed: () =&gt; Trampoline[A]): Trampoline[A] =
  FreeMonad.pure[Function0, Unit](()).flatMap(_ =&gt; delayed())

def even(n: Int): Trampoline[Boolean] =
  if (n eqv 0) FreeMonad.pure(true) else defer(() =&gt; odd(n - 1))

def odd(n: Int): Trampoline[Boolean] =
  if (n eqv 0) FreeMonad.pure(false) else defer(() =&gt; even(n - 1))

val evaluateFunction0: FunctionK[Function0, Id] = new FunctionK[Function0, Id] {
  def apply[A](value: Function0[A]): A = value()
}

def evalTrampoline[A](value: Trampoline[A]): A = FreeMonad.foldMap(value)(evaluateFunction0)

assert(evalTrampoline(even(100000)))
assert(!evalTrampoline(even(100001)))</code></pre>
<div class="source-github">
The source code for this page can be found <a href="https://github.com/salesforce/maligned/tree/main/docs/src/main/paradox/free.md">here</a>.
</div>

</div>
<div class="large-3 show-for-large column" data-sticky-container>
<nav class="sidebar sticky" data-sticky data-anchor="docs" data-sticky-on="large">
<div class="page-nav">
<div class="nav-title">On this page:</div>
<div class="nav-toc">
<ul>
  <li><a href="free.html#free-monad-implemented-with-a-type-aligned-list" class="header">free monad implemented with a type-aligned list</a>
  <ul>
    <li><a href="free.html#the-freemonad-data-structure" class="header">the FreeMonad data structure</a></li>
    <li><a href="free.html#putting-the-monad-in-free-monad" class="header">putting the monad in free monad</a></li>
    <li><a href="free.html#implementing-foldmap" class="header">implementing foldMap</a></li>
    <li><a href="free.html#using-foldmap" class="header">using foldMap</a></li>
  </ul></li>
</ul>
</div>
</div>
</nav>
</div>
</div>

</section>
</div>

</div>

<footer class="site-footer">

<section class="site-footer-nav">
<div class="expanded row">
<div class="small-12 large-offset-2 large-10 column">
<div class="row site-footer-content">

<div class="small-12 medium-4 large-3 text-center column">
<div class="nav-links">
<ul>
<!-- <li><a href="https://www.example.com/products/">Products</a> -->
</ul>
</div>
</div>

</div>
</div>
</div>
</section>

<section class="site-footer-base">
<div class="expanded row">
<div class="small-12 large-offset-2 large-10 column">
<div class="row site-footer-content">

<div class="small-12 text-center large-9 column">

<!--
<div class="copyright">
<span class="text">&copy; 1970</span>
<a href="https://www.example.com" class="logo">logo</a>
</div>
-->
</div>

</div>
</div>
</div>
</section>
</footer>

</div>
</div>
</div>
</body>

<script type="text/javascript" src="lib/foundation/dist/foundation.min.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="js/magellan.js"></script>

<style type="text/css">@import "lib/prettify/prettify.css";</style>
<script type="text/javascript" src="lib/prettify/prettify.js"></script>
<script type="text/javascript" src="lib/prettify/lang-scala.js"></script>
<script type="text/javascript">jQuery(function(){window.prettyPrint && prettyPrint()});</script>
<script type="text/javascript">jQuery(function(jq){initOldVersionWarnings(jq, '0.0.0+1-5d285807-SNAPSHOT', 'https://github.com/salesforce/maligned')});</script>


</html>
